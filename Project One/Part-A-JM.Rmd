---
title: 'DATA 624: Project 1'
author: 'Juliann McEachern'
date: 'October 22, 2019'
documentclass: book
subparagraph: yes
classoption: openany
output: 
  pdf_document:
    highlight: tango
    includes:
      in_header: preamble.tex
    latex_engine: xelatex
    citation_package: natbib
    keep_tex: yes
    number_sections: true
    toc: yes
    toc_depth: 2
---

# Overview {-#overview}

> I am leaving the project overview page here for us to compile our final report in one singular document. We will add additional information here regarding project one to include explanation of process, etc.

## Dependencies {-#dependencies}

> Please add all libraries used here.

The following R libraries were used to complete Project 1:

```{r getting-started, echo=T, eval=T, message=F, warning=F, error=F, comment=F}
# General
library('easypackages')

libraries('knitr', 'kableExtra', 'default')

# Processing
libraries('readxl', 'tidyverse', 'janitor', 'lubridate')

# Graphing
libraries('ggplot2', 'grid', 'gridExtra')

# Timeseries 
libraries('zoo', 'urca', 'tseries', 'timetk')

# Math
libraries('forecast')
```

## Data {-#data}

Data was stored within our group repository and imported below using the `readxl` package. Each individual question was solved within an R script and the data was sourced into our main report for discussion purposes. The R scripts are available within our appendix for replication purposes. 

For grading purposes, we exported and saved all forecasts as a csv in our data folder.

```{r, eval=F}
# Data Aquisition
atm_data <- read_excel("data/ATM624Data.xlsx") 
power_data <- read_excel("data/ResidentialCustomerForecastLoad-624.xlsx") 
pipe1_data <- read_excel("data/Waterflow_Pipe1.xlsx")
pipe2_data <- read_excel("data/Waterflow_Pipe2.xlsx")

# Source Code
source("scripts/Part-A-JM.R")
```

```{r settings-A-JM, echo=F, message=F, warning=F, error=F, comment=F}
### UNIVERSAL DATA SOURCING & DEFAULT SETTINGS FOR PROJECT

# Load All Sourced Code
suppressWarnings(source("scripts/Part-A-JM.R"))

# Set default augments for code chunks
knitr::opts_chunk$set(echo = F, message=F, warning=F, error=F, comment=F, fig.width=10, fig.height = 3)

# Set default augments for `kable_styling()` 
default(kable) <- list(format="latex")
default(kable_styling)  <- list(latex_options = c("HOLD_position", "striped"))
default(row_spec) <- list(row=0, bold=T)

# Set default for ggplot theme
default(theme) <- list(axis.text.x = element_text(angle = 0, hjust = NULL),
                       plot.title = element_text(color="#4c4c4c", size=12, face="bold"),
                       plot.subtitle = (element_text(size=8, color="#000000")),
                       legend.title = (element_text(size=10, color="#000000", face="bold")),
                       strip.background = element_rect(color="#000000", 
                                                       fill="#cccdd0", size=.75, linetype="solid"),
                       strip.text.x = element_text(size = 8, color = "#000000", face="bold"))

# GGplot Palette
default(scale_color_brewer) <- list(palette = 'RdPu', direction=1)
```


# Part A 

>  **Instructions:** In part A, I want you to forecast how much cash is taken out of 4 different ATM machines for May 2010.  The data is given in a single file.  The variable `Cash` is provided in hundreds of dollars, other than that it is straight forward.  I am being somewhat ambiguous on purpose.  I am giving you data, please provide your written report on your findings, visuals, discussion and your R code all within a Word readable document, except the forecast which you will put in an Excel readable file.  I must be able to cut and paste your R code and run it in R studio.  Your report must be professional - most of all - readable, EASY to follow.  Let me know what you are thinking, assumptions you are making!  Your forecast is a simple CSV or Excel file that MATCHES the format of the data I provide.

## Exploration

Through data exploration, we identified that the original data file contained `NA` values in our `ATM` and `Cash` columns for 14 observations in May 2010. We removed these missing values and transformed the dataset into a wide format.  Our cleaned dataframe was then converted into a timeseries format using the `zoo` package for forecasting in the next section. Our initial review of the data showed that ATM2 contained one missing value on 2009-10-25 and that ATM4 contained a potential outlier of $1123 on 2010-02-09. We replaced both values with the corresponding mean value of each machine. 

Next, we used a scatterplot to take an initial look at the correlation between cash withdrawals and dates for each machine.  We can identified similiar patterns between ATM1 and ATM4, which show non-linear fluxuations that suggest a potential trend component in these timeseries. ATM2 follows a relatively linear path and decreases overtime. This changes in the last few observations, where withdrawals begin to increase. There are only 3 observed transactions for ATM3 that appear at the end of the captured time period. 

```{r}
# plot atms as scatterplot
atm %>% 
  # re-gather observations for facet plot
  gather(key=ATM, value=Cash, ATM1,ATM2, ATM3,ATM4) %>% 
  # remove NA value from ATM2
  filter(complete.cases(.)) %>% 
  # plot 
  ggplot(aes(DATE, Cash, color=ATM)) +
  geom_point() +
  geom_smooth(method="loess") +
  facet_wrap(~ATM, scales='free_x', nrow=1) +
  labs(title="ATM Scatterplot",x="", y="Cash (in hundreds)")+
  theme_bw()+
  theme(legend.position = 'none', axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_brewer()
```

## Timeseries Plots 

As mentioned in our data exploration, the time series for ATM3 only contains 3 transactions, thus we deemed this series not suitable for modeling and forecasting. As a result, our following sections focus on evaluating, modeling, and forecasting transactions for only the ATM1, ATM2, and ATM4 series.

```{r, fig.height=5}
autoplot(atm_zoo)+
  labs(title = "Daily ATM Transactions", subtitle = "Series: ATM1", y="Cash (in hundreds)", x="")+ 
  theme_bw()+ theme()
```

## Evaluation 

We constructed our timeseries using a weekly frequency. Our ACF plots for each ATM showcases large, decreasing lags starting at 7. This pattern continues in a multiple of seven, which confirms our assumption about seasonality within the observed data. These lags are indicative of a weekly pattern. 

```{r fig.height=4}
p1<-ggAcf(ATM1_ts)+ labs(title="ACF: ATM1")+ theme_bw()+theme()
p2<-ggPacf(ATM1_ts)+ labs(title="PACF: ATM1")+ theme_bw()+ theme()
p3<-ggAcf(ATM2_ts)+ labs(title="ACF: ATM2")+ theme_bw()+theme()
p4<-ggPacf(ATM2_ts)+ labs(title="PACF: ATM2")+ theme_bw()+ theme()
p5<-ggAcf(ATM4_ts)+ labs(title="ACF: ATM4")+ theme_bw()+theme()
p6<-ggPacf(ATM4_ts)+ labs(title="PACF: ATM4")+ theme_bw()+ theme()

grid.arrange(grob=p1, p3, p5, p2, p4, p6, ncol=3)
```

Our plots further suggest that the ATM data is non-stationary. We performed a unit root test using the `ur.kpss()` function to confirm this observation. The test results below show that second differencing is required on all three series. 

```{r}
urATM1<-cbind("ATM"="ATM1", "No-Diff"=round(ATM1_ur@teststat,4),"Diff-1" =round(ATM1d_ur@teststat,4))

urATM2<-cbind("ATM"="ATM2", "No-Diff"=round(ATM2_ur@teststat,4),"Diff-1" =round(ATM2d_ur@teststat,4))

urATM4<-cbind("ATM"="ATM4", "No-Diff"=round(ATM4_ur@teststat,4),"Diff-1" =round(ATM4d_ur@teststat,4))

rbind(urATM1, urATM2,urATM4) %>% kable(caption="KPSS unit root test") %>% kable_styling() %>% row_spec()
```

### Modeling 

We used `auto.arima()` on our differenced data to select the best ARIMA model for our series. The following models were selected based on AICc values:

*  **ATM1**: ARIMA(0,1,2)(0,2,1)$_7$ with errors 
*  **ATM2**: ARIMA(0,1,3)(0,2,1)$_7$ with errors 
*  **ATM4**: ARIMA(0,1,2)(0,2,1)$_7$ with errors 

The following ACF plots show us that our differentiated data is now stationary and the residual histograms confirm that the model adequately fits the observed data. 

```{r}
p1<-ggAcf(ATM1_arima$residuals, lag=21)+ labs(title="ATM1", x="Lag", y="") +theme_bw()+theme()
p2<- gghistogram(ATM1_arima$residuals, add.normal = T)+
  labs(title="ATM1", subtitle="ARIMA(0,1,2)(0,2,1)[7]",x="")+
  theme_bw()+theme()
p3<-ggAcf(ATM2_arima$residuals, lag=21)+ labs(title="ATM2",x="Lag", y="") +theme_bw()+theme()
p4<-gghistogram(ATM2_arima$residuals, add.normal = T)+
  labs(title="ATM2", subtitle="ARIMA(0,1,3)(0,2,1)[7]",x="")+
  theme_bw()+theme()
p5<-ggAcf(ATM4_arima$residuals, lag=21)+ labs(title="ATM3",x="Lag", y="") +theme_bw()+theme()
p6<-gghistogram(ATM4_arima$residuals, add.normal = T)+
  labs(title="ATM4", subtitle="ARIMA(0,1,2)(0,2,1)[7]", x="")+
  theme_bw()+theme()

grid.arrange(grob=p1, p3, p5, ncol=3, top=textGrob(label="ACF Plots"))
             
grid.arrange(p2, p4, p6, ncol=3, top=textGrob(label="Residuals Plots"))
```

### Forecast

Finally, we applied a forecast to each series for 4 weeks of May. The full forecasts can be viewed in the appendix section and are also located within our data output folder.   

```{r}
p1<-autoplot(ATM1_arima$fitted)+autolayer(ATM1_fc)+
  coord_cartesian(xlim = c(45, 54))+
  labs(subtitle = "ATM1 Series", x="Weeks", y="Cash")+theme_bw()+theme()
p2<-autoplot(ATM2_arima$fitted)+autolayer(ATM2_fc)+
  coord_cartesian(xlim = c(45, 54))+
  labs(subtitle = "ATM2 Series", x="Weeks", y="Cash")+theme_bw()+theme()
p3<-autoplot(ATM4_arima$fitted)+autolayer(ATM4_fc)+
  coord_cartesian(xlim = c(45, 54))+
  labs(subtitle = "ATM4 Series", x="Weeks", y="Cash")+theme_bw()+theme()

grid.arrange(p1, p2, p3, ncol=3, top=textGrob(label="ATM Forecasts"))
```


# Appendix {-#Appendix}

## Part A {-#Part-A}

### Forecast Tables {-#Part-A-FC}

```{r}
ATM1_fc %>% kable(caption="ATM1 Forecast") %>% kable_styling() %>% row_spec()
ATM2_fc %>% kable(caption="ATM2 Forecast") %>% kable_styling() %>% row_spec()
ATM4_fc %>% kable(caption="ATM4 Forecast") %>% kable_styling() %>% row_spec()
```


### R Script {-#Part-A-RScript}

```{r, echo=T, eval=F}
# load data
atm_data <- read_excel("data/ATM624Data.xlsx") 

# clean dataframe
atm <- atm_data %>% 
  # create wide dataframe
  spread(ATM, Cash) %>% 
  # remove NA column using function from janitor package
  remove_empty(which = "cols") %>%
  # filter unobserved values from May 2010
  filter(DATE < as.Date("2010-05-01")) %>%
  # ensure dates are ascending
  arrange(DATE) 

## remove NA
atm$ATM2[is.na(atm$ATM2)] <- mean(atm$ATM2, na.rm = TRUE)

## remove outlier
atm$ATM4[which.max(atm$ATM4)] <- mean(atm$ATM4, na.rm = TRUE)

# create zoo time series   
atm_zoo <- atm %>%  
  # remove column & generate date in timeseries using zoo
  select(-DATE) %>% 
  # generate ts using zoo 
  zoo(seq(from = as.Date("2009-05-01"), to = as.Date("2010-05-01"), by = 1))

# create standard time series   
atm_ts <- atm %>%  
  # remove column & generate date in timeseries using zoo
  select(-DATE) %>% 
  # generate ts using zoo 
  ts(start=1,  frequency = 7)

#subset data 
ATM1_zoo <- atm_zoo[,1]; ATM1_ts <- atm_ts[,1]
ATM4_zoo <- atm_zoo[,4]; ATM4_ts <- atm_ts[,4]
ATM2_zoo <- atm_zoo[,2]; ATM2_ts <- atm_ts[,2]

#unit root test
## no diff
ATM1_ur <-ur.kpss(ATM1_ts)
ATM2_ur <-ur.kpss(ATM2_ts)
ATM4_ur <-ur.kpss(ATM4_ts)
## first order diff
ATM1d_ur <-ur.kpss(diff(ATM1_ts, lag=7))
ATM2d_ur <-ur.kpss(diff(ATM2_ts, lag=7))
ATM4d_ur <-ur.kpss(diff(ATM4_ts, lag=7))
## seasonal diff
ATM1sd_ur <-ur.kpss(diff(log(ATM1_ts), lag=7))
ATM2sd_ur <-ur.kpss(diff(log(ATM2_ts), lag=7))
ATM4sd_ur <-ur.kpss(diff(log(ATM4_ts), lag=7))
## seasonal diff-diff
ATM1sdd_ur <-ur.kpss(diff(diff(log(ATM1_ts)), lag=7))
ATM2sdd_ur <-ur.kpss(diff(diff(log(ATM2_ts)), lag=7))
ATM4sdd_ur <-ur.kpss(diff(diff(log(ATM4_ts)), lag=7))

# Modeling 
## Lambda for Box-cox transformation
ATM1_lambda <- BoxCox.lambda(ATM1_ts)
ATM2_lambda <- BoxCox.lambda(ATM2_ts)
ATM4_lambda <- BoxCox.lambda(ATM4_ts)

## ARIMA
ATM1_arima<-Arima(ATM1_ts, order = c(1, 0, 1), 
                  seasonal=list(order=c(0, 2, 1),period = 7), 
                  lambda=ATM1_lambda,  method="ML")

ATM2_arima<-Arima(ATM2_ts, order = c(2, 1, 2), 
                  seasonal=list(order=c(2, 1, 2),period = 7), 
                  lambda=ATM2_lambda,  method="ML")

ATM4_arima<-Arima(ATM4_ts, order = c(1, 0, 1), 
                  seasonal=list(order=c(1, 1, 1),period = 7), 
                  lambda=ATM1_lambda, method="ML")

# Forecast
ATM1_fc <- forecast(ATM1_arima,h=4)
ATM2_fc <- forecast(ATM2_arima,h=4)
ATM4_fc <- forecast(ATM4_arima,h=4)

# Save output
write.csv(ATM1_fc, file="forecasts/ATM1_Forecast.csv")
write.csv(ATM2_fc, file="forecasts/ATM2_Forecast.csv")
write.csv(ATM4_fc, file="forecasts/ATM4_Forecast.csv")
```



